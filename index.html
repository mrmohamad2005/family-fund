<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Family Fund | Ø³ÛŒØ³ØªÙ… Ù…Ø¯Ø±Ù†</title>

    <link rel="manifest" href="/family-fund/manifest.json">
    <link rel="icon" type="image/png" href="app-icon.png"> <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <style>
        /* --- Ø§Ø³ØªØ§ÛŒÙ„ Ù‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ Ùˆ Ù…ØªØºÛŒØ±Ù‡Ø§ --- */
        :root {
            --bg-body: #f3f4f6;
            --primary: #4f46e5;
            --glass-bg: rgba(255, 255, 255, 0.9);
            --card-bg: #ffffff;
            --red-soft-bg: #fee2e2;
            --red-text: #b91c1c;
            --green-soft-bg: #dcfce7;
            --green-text: #15803d;
            --yellow-soft-bg: #fef9c3; 
            --yellow-text: #a16207;
            --winner-color: #f59e0b;
            --blue-pending-bg: #bfdbfe; 
            --blue-pending-text: #1d4ed8;

            --blue-glow: 0 0 15px rgba(59, 130, 246, 0.5), 0 0 3px rgba(59, 130, 246, 0.3);
            --radius: 24px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: var(--bg-body);
            color: #1f2937;
            margin: 0;
            padding-top: 190px; 
            padding-bottom: 100px;
            overflow-x: hidden;
        }

        /* --- Ù†ÙˆÛŒÚ¯ÛŒØ´Ù† Ø¨Ø§Ø± (Ø«Ø§Ø¨Øª) --- */
        .navbar {
            position: fixed;
            top: 0; width: 100%; height: 70px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        /* --- Ú©Ø§Ù†ØªÛŒÙ†Ø± Ø§ØµÙ„ÛŒ --- */
        .container {
            max-width: 700px; margin: 0 auto; padding: 0 20px;
        }

        /* ğŸš€ Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ú¯Ø±Ø§ÙÛŒÚ©ÛŒ Ø´Ù…Ø§Ø±Ø´ Ù…Ø¹Ú©ÙˆØ³ ğŸš€ */
        #countdownContainer {
            position: fixed;
            top: 70px; 
            left: 0;
            width: 100%;
            padding: 15px 0;
            background: linear-gradient(90deg, #6366f1 0%, #3b82f6 100%);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            color: white;
            z-index: 90;
        }

        .countdown-header {
            text-align: center;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 10px;
        }
        
        .timer-grid {
            display: flex;
            justify-content: center;
            gap: 10px;
            max-width: 600px;
            margin: auto;
            padding: 0 20px;
        }

        .timer-unit {
            text-align: center;
            padding: 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            flex: 1;
            min-width: 50px;
            backdrop-filter: blur(5px);
        }

        .timer-value {
            font-size: 1.6rem;
            font-weight: 900;
            line-height: 1.2;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5); 
        }

        .timer-label {
            font-size: 0.7rem;
            opacity: 0.8;
            margin-top: 2px;
        }
        
        /* --- Ø³Ø§ÛŒØ± Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ --- */
        .logo { font-weight: 900; color: var(--primary); font-size: 1.2rem; }
        .sidebar {
            position: fixed; top: 0; right: 0; height: 100%; width: 300px; 
            background: var(--card-bg); z-index: 101; transform: translateX(300px); 
            transition: transform 0.3s ease-out; padding: 20px; box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; 
        }
        .sidebar.active { transform: translateX(0); }
        .sidebar-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0, 0, 0, 0.5); z-index: 100; opacity: 0; 
            pointer-events: none; transition: opacity 0.3s ease-out; 
        }
        .sidebar-overlay.active { opacity: 1; pointer-events: auto; }
        .hamburger { cursor: pointer; display: flex; flex-direction: column; gap: 4px; }
        .hamburger span { width: 25px; height: 3px; background: #333; border-radius: 1px; }

        .btn-nav {
            background: var(--primary); color: white;
            padding: 8px 16px; border-radius: 12px;
            text-decoration: none; font-weight: bold; font-size: 0.9rem;
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.4);
            transition: 0.2s;
            margin-right: 5px; 
        }
        
        .member-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 25px;
            position: relative;
            box-shadow: var(--blue-glow);
            border: 1px solid rgba(59, 130, 246, 0.2);
            transition: transform 0.2s;
        }
        .member-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .member-name { font-weight: 700; font-size: 1.1rem; }
        .member-phone { color: #6b7280; font-size: 0.9rem; margin-top: 3px; }
        .status-badge { 
            padding: 5px 10px; border-radius: 10px; font-size: 0.75rem; font-weight: 700; white-space: nowrap;
        }
        .status-paid { background: var(--green-soft-bg); color: var(--green-text); }
        .status-unpaid { background: var(--red-soft-bg); color: var(--red-text); }
        .status-awaiting-approval { background: var(--yellow-soft-bg); color: var(--yellow-text); }

        .action-row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; border-top: 1px dashed #e5e7eb; padding-top: 10px; }
        .btn {
            padding: 8px 12px; border: none; border-radius: 8px; cursor: pointer; 
            font-weight: 600; font-size: 0.85rem; transition: background 0.2s; flex-grow: 1;
        }
        .btn-upload { background: var(--primary); color: white; }
        .btn-receipt { background: #e0f2f1; color: #0f766e; }
        .btn-nudge { background: #fef3c7; color: #b45309; position: relative;}
        .btn-disabled { background: #e5e7eb; color: #9ca3af; cursor: not-allowed; }
        .nudge-count {
            position: absolute; top: -5px; right: -5px; background: var(--red-text); color: white;
            border-radius: 50%; padding: 2px 6px; font-size: 0.6rem; line-height: 1;
        }

        /* --- Ø§Ø³ØªØ§ÛŒÙ„ Ù‡Ø§ÛŒ Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± --- */
        .user-profile-card {
            background: var(--bg-body); padding: 15px; border-radius: 15px; text-align: center;
            border: 1px solid #ccc; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        /* ... Ø³Ø§ÛŒØ± Ø§Ø³ØªØ§ÛŒÙ„ Ù‡Ø§ÛŒ Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± ... */
        
        /* --- Ø§Ø³ØªØ§ÛŒÙ„ Ù‡Ø§ÛŒ Ù…ÙˆØ¯Ø§Ù„ Ùˆ ÙØ±Ù… --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0, 0, 0, 0.6); display: none; justify-content: center; 
            align-items: center; z-index: 200; backdrop-filter: blur(5px);
        }
        .modal-content {
            background: white; padding: 30px; border-radius: var(--radius); 
            max-width: 90%; width: 400px; max-height: 90vh; overflow-y: auto;
            position: relative; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        .modal-content-lg { width: 600px; }
        .form-input { 
            width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; 
            border-radius: 10px; font-size: 1rem; font-family: 'Vazirmatn', sans-serif;
            transition: border-color 0.2s;
        }
        .form-input:focus { border-color: var(--primary); }
        .btn-full { 
            width: 100%; padding: 12px; background: var(--primary); color: white; 
            border: none; border-radius: 10px; cursor: pointer; font-size: 1rem; 
            font-weight: 700; margin-top: 15px; transition: background 0.2s;
        }

        /* --- Ø§Ø³ØªØ§ÛŒÙ„ Ù‡Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ù¾Ù†Ù„ --- */
        #adminPanel { display: none; padding: 20px; }
        .password-form-container { max-width: 400px; margin: 50px auto; padding: 30px; background: white; border-radius: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); text-align: center; }
        
        .admin-stat-grid { display: flex; gap: 15px; margin-top: 20px; flex-wrap: wrap; }
        .admin-stat-card {
             flex: 1; min-width: 150px; background: white; padding: 15px; border-radius: 15px; 
             box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        /* --- Ø§Ø³ØªØ§ÛŒÙ„ Ø¯Ú©Ù…Ù‡ Ø±ÛŒØ³Øª Ú©Ø§Ù…Ù„ --- */
        .btn-reset-all {
             background: #ef4444; 
             color: white;
             padding: 12px;
             border: none;
             border-radius: 10px;
             cursor: pointer;
             font-size: 1rem;
             font-weight: 700;
             margin-top: 20px;
             transition: background 0.2s;
             box-shadow: 0 4px 10px rgba(239, 68, 68, 0.4);
        }
        
        /* --- Ø§Ø³ØªØ§ÛŒÙ„ Ø¯Ú©Ù…Ù‡ Ù‡Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª --- */
        .admin-options-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-top: 20px;
        }
        .admin-options-card h3 {
             border-bottom: 1px solid #e5e7eb;
             padding-bottom: 10px;
             margin-top: 0;
        }
        .admin-options-card input {
            margin-bottom: 10px;
        }
        /* --- Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÙˆÙ„ Ø§Ø¯Ù…ÛŒÙ† --- */
        .admin-table-container {
             overflow-x: auto;
             width: 100%;
             margin-top: 20px;
             background: white;
             border-radius: 15px;
             box-shadow: 0 5px 15px rgba(0,0,0,0.05);
             padding: 10px;
        }
        .admin-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px; /* ÙØ§ØµÙ„Ù‡ Ø¨ÛŒÙ† Ø±Ø¯ÛŒÙ Ù‡Ø§ */
        }
        .admin-table th, .admin-table td {
             padding: 12px 10px;
             text-align: right;
             vertical-align: middle;
             font-size: 0.9rem;
        }
        .admin-table thead {
             background-color: #f3f4f6;
             position: sticky;
             top: 0;
             z-index: 10;
        }
        .admin-table th {
            font-weight: 700;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
            text-align: center;
        }
        .admin-table td:last-child {
             display: flex;
             flex-wrap: wrap;
             gap: 5px;
             justify-content: center;
        }
        .admin-table tbody tr {
             background: var(--card-bg);
             transition: background-color 0.2s;
             box-shadow: 0 1px 5px rgba(0,0,0,0.02);
        }
        .admin-table tbody tr:hover {
            background: #f9fafb;
        }
        .admin-table .pending-row {
            background-color: var(--yellow-soft-bg);
            border-right: 5px solid var(--yellow-text);
        }
        .admin-table .pending-row:hover {
            background-color: #fcfdf5;
        }
        .btn-admin {
            padding: 6px 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
            transition: opacity 0.2s;
        }
        .btn-verify-member { background: #10b981; color: white; }
        .btn-verify-payment { background: #2563eb; color: white; }
        .btn-delete-member { background: #fca5a5; color: #b91c1c; }
        .btn-select-winner { background: var(--winner-color); color: white; }
        
        .monthly-archive-container {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
             gap: 15px;
        }
        .monthly-archive-box {
             background: var(--card-bg);
             padding: 15px;
             border-radius: 15px;
             box-shadow: 0 5px 15px rgba(0,0,0,0.05);
             cursor: pointer;
             border-right: 4px solid #e5e7eb;
             transition: all 0.2s;
        }
        .monthly-archive-box:hover {
             transform: translateY(-2px);
             box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        .monthly-archive-box.active {
             border-right: 4px solid var(--primary);
             background: #eff6ff;
        }
        .archive-header {
             display: flex;
             justify-content: space-between;
             font-size: 0.9rem;
             font-weight: 600;
        }
        .archive-stats {
             color: #6b7280;
             font-weight: 500;
        }
        
        /* --- Toast Ùˆ Ø³Ø§ÛŒØ± Ø¹Ù†Ø§ØµØ± --- */
        .toast {
            position: fixed; bottom: 20px; right: 20px; background: #333; color: white;
            padding: 10px 20px; border-radius: 10px; opacity: 0; transition: opacity 0.3s, transform 0.3s;
            transform: translateY(50px); z-index: 300; font-size: 0.9rem;
            display: flex; align-items: center; gap: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        
        /* --- Ø§Ø³ØªØ§ÛŒÙ„ Ø®Ù„Ø§ØµÙ‡ Ù…Ø§Ù‡Ø§Ù†Ù‡ --- */
        .summary-stat {
             flex: 1; min-width: 150px; background: #f9fafb; padding: 15px; border-radius: 10px;
             box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }
        .paid-list {
             display: grid; gap: 10px;
             border: 1px solid #e5e7eb; padding: 15px; border-radius: 10px;
        }
        .paid-item {
             display: flex; justify-content: space-between; align-items: center;
             padding-bottom: 5px; border-bottom: 1px dashed #f3f4f6;
             font-size: 0.95rem;
        }
        .paid-item-name { font-weight: 600; }
        .paid-item-date { color: #6b7280; font-size: 0.85rem; }
        
        .receipt-history-item {
             border: 1px solid #e5e7eb;
             padding: 10px;
             margin-bottom: 15px;
             border-radius: 10px;
             text-align: center;
        }
        .receipt-history-item img {
             max-width: 100%;
             border-radius: 8px;
             margin-top: 10px;
        }
        
        .msg-header {
             display: flex;
             justify-content: space-between;
             align-items: center;
             font-weight: 700;
             font-size: 1.1rem;
        }
        .msg-count {
            background: var(--red-text);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
        }
        #adminNotificationCard {
             background: var(--red-soft-bg);
             color: var(--red-text);
             padding: 15px;
             border-radius: 15px;
             margin-top: 20px;
             cursor: pointer;
        }
        
    </style>
</head>
<body>

    <div id="toast" class="toast">
        <span>ğŸ””</span> <span id="toastMsg">Ù¾ÛŒØ§Ù… Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯</span>
    </div>
    
    <div id="userLoginModal" class="modal" style="display: flex;">
        <div class="modal-content">
            <h2>ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ…</h2>
            <p>Ù„Ø·ÙØ§Ù‹ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¹Ù…ÙˆÙ…ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.</p>
            <form onsubmit="checkUserPassword(event)">
                <input type="password" id="userPassword" class="form-input" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¹Ù…ÙˆÙ…ÛŒ (Ù¾ÛŒØ´â€ŒÙØ±Ø¶: 123)" required>
                <button class="btn-full" style="background: var(--green-text);">ÙˆØ±ÙˆØ¯</button>
            </form>
        </div>
    </div>
    
    
    <nav class="navbar" id="mainNavBar" style="display: none;">
        <div style="display:flex; align-items:center; gap:15px;">
            <div class="hamburger" onclick="toggleSidebar()">
                <span></span><span></span><span></span>
            </div>
            <div class="logo">Family Fund</div>
        </div>
        <div style="display:flex;">
             <a href="#" class="btn-nav" style="background:#dc2626;" onclick="showAdminPanel()">ğŸ”’ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª</a>
            <a href="#" class="btn-nav" id="btnJoinNav" onclick="openModal('joinModal')">+ Ø¹Ø¶ÙˆÛŒØª</a>
        </div>
    </nav>

    <div id="countdownContainer" style="display: none;">
        <div class="countdown-header">Ø²Ù…Ø§Ù† Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ ØªØ§ Ù¾Ø§ÛŒØ§Ù† Ù…Ø§Ù‡ **Ø¢Ø°Ø±** Ùˆ Ù‚Ø±Ø¹Ù‡â€ŒÚ©Ø´ÛŒ</div>
        <div class="timer-grid" id="countdownTimer">
             <div class="timer-unit">
                <div class="timer-value" id="timerDays">00</div>
                <div class="timer-label">Ø±ÙˆØ²</div>
            </div>
            <div class="timer-unit">
                <div class="timer-value" id="timerHours">00</div>
                <div class="timer-label">Ø³Ø§Ø¹Øª</div>
            </div>
            <div class="timer-unit">
                <div class="timer-value" id="timerMinutes">00</div>
                <div class="timer-label">Ø¯Ù‚ÛŒÙ‚Ù‡</div>
            </div>
            <div class="timer-unit">
                <div class="timer-value" id="timerSeconds">00</div>
                <div class="timer-label">Ø«Ø§Ù†ÛŒÙ‡</div>
            </div>
        </div>
    </div>


    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
    <aside class="sidebar">
        <div id="sidebarProfileCard"></div>
        <h2 style="border-bottom:2px solid #f3f4f6; padding-bottom:15px;">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</h2>
        <div class="winners-box">
            <h3>ğŸ† Ø¨Ø±Ù†Ø¯Ù‡ Ø§Ø®ÛŒØ±</h3> 
            <div id="currentWinnerProfile">
                <p style="font-size:0.9rem; color:#666; text-align:center;">Ù‡Ù†ÙˆØ² Ø¨Ø±Ù†Ø¯Ù‡ Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>
            </div>
        </div>
         <div style="margin-top: auto; padding-top: 20px; text-align: center; font-size: 0.8rem; color: #999;">
             Ù†Ø³Ø®Ù‡ v4.9 (Ø¨Ø§ Ù‚Ø§Ø¨Ù„ÛŒØª Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±)
        </div>
    </aside>
    
    <div class="container" id="mainAppContainer" style="display: none;">
        
        <div style="display:flex; gap:10px; margin-bottom:30px; margin-top:20px;">
            <div style="flex:1; background:white; padding:15px; border-radius:20px; text-align:center; box-shadow:0 5px 15px rgba(0,0,0,0.05);">
                <div style="font-size:0.8rem; color:#888;">Ù…ÙˆØ¬ÙˆØ¯ÛŒ ØµÙ†Ø¯ÙˆÙ‚ (Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ)</div>
                <div style="font-size:1.4rem; font-weight:900; color:var(--primary);" id="totalFund">0</div>
            </div>
            <div style="flex:1; background:white; padding:15px; border-radius:20px; text-align:center; box-shadow:0 5px 15px rgba(0,0,0,0.05);">
                <div style="font-size:0.8rem; color:#888;">Ú©Ù„ Ø§Ø¹Ø¶Ø§ (ØªØ£ÛŒÛŒØ¯ Ø´Ø¯Ù‡)</div>
                <div style="font-size:1.4rem; font-weight:900;" id="totalMembers">0</div>
            </div>
        </div>

        <div id="membersList">
        </div>
        
        <div id="emptyState" class="empty-state">
            <p>Ù„ÛŒØ³Øª Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.<br>Ø§Ø² Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ù„Ø§ Ø¹Ø¶Ùˆ Ø´ÙˆÛŒØ¯.</p>
        </div>

    </div>

    <div id="adminPanel">
        <div id="passwordForm" class="password-form-container">
            <h2 style="color:var(--primary);">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª</h2>
            <form onsubmit="checkAdminPassword(event)">
                <input type="password" id="adminPassword" class="form-input" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±" required>
                <button class="btn-full" style="background:#dc2626;">ÙˆØ±ÙˆØ¯</button>
            </form>
        </div>

        <div id="adminContent" style="display:none;">
            <div id="adminDashboard" class="container" style="max-width: 1000px;">
                <h2 style="color:#111; border-bottom: 2px solid #ccc; padding-bottom: 10px;">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø¯ÛŒØ±ÛŒØª</h2>

                <div id="adminNotificationCard" onclick="scrollToTable()">
                    <div class="msg-header">
                        <span>âš ï¸ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¹Ø¶ÙˆÛŒØª Ø¬Ø¯ÛŒØ¯!</span>
                        <span class="msg-count" id="newMemberCount"></span>
                    </div>
                    <p style="font-size:0.9rem; margin: 5px 0 0 0;">Ù„Ø·ÙØ§Ù‹ Ø§Ø¹Ø¶Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ ØªØ£ÛŒÛŒØ¯ Ú©Ù†ÛŒØ¯ ØªØ§ Ø¯Ø± Ù„ÛŒØ³Øª Ø§ØµÙ„ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆÙ†Ø¯.</p>
                </div>

                <div class="admin-stat-grid">
                    <div class="admin-stat-card" style="border-right: 5px solid var(--primary);">
                        <h4>Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ</h4>
                        <div class="value" id="currentMonthName"></div>
                    </div>
                    <div class="admin-stat-card" style="border-right: 5px solid var(--green-text);">
                        <h4>Ù¾Ø±Ø¯Ø§Ø®ØªÛŒâ€ŒÙ‡Ø§ÛŒ Ù…ÙˆÙÙ‚</h4>
                        <div class="value" id="adminPaidCount">0</div>
                    </div>
                    <div class="admin-stat-card" style="border-right: 5px solid var(--winner-color);">
                        <h4>Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÛŒÛŒØ¯</h4>
                        <div class="value" id="adminAwaitingCount">0</div>
                    </div>
                    <div class="admin-stat-card" style="border-right: 5px solid var(--red-text);">
                        <h4>Ú©Ù„ Ù…Ø¨Ù„Øº Ø¬Ù…Ø¹ Ø´Ø¯Ù‡ (ÙØ¹Ù„ÛŒ)</h4>
                        <div class="value" id="adminTotalFund">0</div>
                    </div>
                </div>

                <h3 style="margin-top: 30px; padding-top: 10px; border-top: 2px dashed #e5e7eb;">Ø¢Ø±Ø´ÛŒÙˆ Ù…Ø§Ù‡Ø§Ù†Ù‡</h3>
                <p style="color:#666; font-size: 0.9rem;">Ø¨Ø§ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ù‡Ø± Ø¨Ø§Ú©Ø³ Ø¢Ø±Ø´ÛŒÙˆØŒ Ø®Ù„Ø§ØµÙ‡ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ÛŒ Ø¢Ù† Ù…Ø§Ù‡ Ø±Ø§ Ø¨Ø¨ÛŒÙ†ÛŒØ¯. Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØªØŒ Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</p>

                <div id="monthlyArchivesContainer" class="monthly-archive-container">
                </div>
                
                <h3 id="currentMonthTitle" style="margin-top: 30px; padding-top: 10px; border-top: 2px solid #e5e7eb;">Ø¬Ø¯ÙˆÙ„ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø¹Ø¶Ø§ÛŒ Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ</h3>
                <p style="color:#666; font-size: 0.9rem;">Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ Ø²Ø±Ø¯/Ù†Ø§Ø±Ù†Ø¬ÛŒ: Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªØ£ÛŒÛŒØ¯ Ø´Ù…Ø§ Ø¯Ø§Ø±Ù†Ø¯. (Ø¹Ø¶ÙˆÛŒØª Ø¬Ø¯ÛŒØ¯ ÛŒØ§ ÙÛŒØ´ ÙˆØ§Ø±ÛŒØ²ÛŒ)</p>


                <div class="admin-table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Ù†Ø§Ù…</th>
                                <th>Ø´Ù…Ø§Ø±Ù‡</th>
                                <th>ÙˆØ¶Ø¹ÛŒØª</th>
                                <th>ØªØ¹Ø¯Ø§Ø¯ ÙÛŒØ´</th>
                                <th>ØªØ°Ú©Ø±</th>
                                <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="adminMembersTableBody">
                        </tbody>
                    </table>
                </div>
                
                <div class="admin-options-card">
                    <h3>ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</h3>
                    <form onsubmit="changeAdminPassword(event)">
                        <h4 style="font-size: 1rem; margin-top: 15px; margin-bottom: 5px;">ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª (Ø§Ø¯Ù…ÛŒÙ†)</h4>
                        <input type="password" id="newAdminPassword" class="form-input" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¬Ø¯ÛŒØ¯ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª" required>
                        <button class="btn-full" style="background:#5a67d8;">ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ø§Ø¯Ù…ÛŒÙ†</button>
                    </form>
                    
                    <form onsubmit="changeUserPassword(event)">
                        <h4 style="font-size: 1rem; margin-top: 25px; margin-bottom: 5px; border-top: 1px dashed #e5e7eb; padding-top: 15px;">ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¹Ù…ÙˆÙ…ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h4>
                        <input type="password" id="newUserPassword" class="form-input" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¬Ø¯ÛŒØ¯ Ø¹Ù…ÙˆÙ…ÛŒ (Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†)" required>
                        <button class="btn-full" style="background:#059669;">ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</button>
                    </form>
                </div>


                <div style="display: flex; gap: 15px; margin-top: 30px; max-width: 600px; margin-left: auto; margin-right: auto;">
                    <button onclick="hideAdminPanel()" class="btn-full" style="background: #6b7280; flex-grow: 1;">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ</button>
                    <button onclick="resetAllData()" class="btn-reset-all" style="flex-grow: 1;">âŒ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª</button>
                </div>
                

            </div>
        </div>
    </div>


    <div id="joinModal" class="modal">
        <div class="modal-content">
            <span onclick="closeModal('joinModal')" style="float:left; cursor:pointer; font-size:1.5rem;">&times;</span>
            <h2>Ø¹Ø¶ÙˆÛŒØª Ø¬Ø¯ÛŒØ¯</h2>
            <form onsubmit="handleJoin(event)">
                <input id="joinName" class="form-input" placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ" required>
                <input id="joinPhone" class="form-input" type="tel" placeholder="Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„" required>
                <button class="btn-full">Ø«Ø¨Øª Ù†Ø§Ù…</button>
            </form>
        </div>
    </div>

    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <span onclick="closeModal('uploadModal')" style="float:left; cursor:pointer; font-size:1.5rem;">&times;</span>
            <h2>Ø«Ø¨Øª/ÙˆÛŒØ±Ø§ÛŒØ´ ÙÛŒØ´ ÙˆØ§Ø±ÛŒØ²ÛŒ</h2>
            <form onsubmit="handleUpload(event)">
                <input type="hidden" id="uploadUserId">
                <input type="file" id="uploadFile" class="form-input" accept="image/*" required>
                <button class="btn-full" style="background:#10b981;">Ø§Ø±Ø³Ø§Ù„ ÙÛŒØ´ Ø¬Ø¯ÛŒØ¯</button>
            </form>
        </div>
    </div>

    <div id="adminReceiptsModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span onclick="closeModal('adminReceiptsModal')" style="float:left; cursor:pointer; font-size:1.5rem;">&times;</span>
            <h3 id="adminReceiptsModalTitle">ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø±Ø³ÛŒØ¯Ù‡Ø§</h3>
            <div id="receiptsHistoryContent" style="max-height: 70vh; overflow-y: auto; margin-top: 20px;">
            </div>
        </div>
    </div>
    
    <div id="receiptModal" class="modal">
        <div class="modal-content">
            <span onclick="closeModal('receiptModal')" style="float:left; cursor:pointer; font-size:1.5rem;">&times;</span>
            <h3>Ø¢Ø®Ø±ÛŒÙ† Ø±Ø³ÛŒØ¯ ÙˆØ§Ø±ÛŒØ²ÛŒ</h3>
            <img id="receiptImg" style="width:100%; border-radius:10px; margin-top:10px;">
        </div>
    </div>

    <div id="summaryModal" class="modal">
        <div class="modal-content modal-content-lg">
            <span onclick="closeModal('summaryModal')" style="float:left; cursor:pointer; font-size:1.5rem;">&times;</span>
            <h3 id="summaryTitle">Ø®Ù„Ø§ØµÙ‡ Ù…Ø§Ù‡Ø§Ù†Ù‡</h3>
            <div id="summaryContent">
            </div>
        </div>
    </div>


    <script>
        // --- State Management ---
        const DB_KEY = 'family_fund_v4_members'; 
        const ARCHIVE_KEY = 'family_fund_v4_monthly_archive'; 
        const USER_ID_KEY = 'current_user_id'; 
        const WINNER_KEY = 'current_family_fund_winner'; 
        
        // ğŸ”‘ Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± 
        const ADMIN_PASS_KEY = 'admin_password_storage';
        const USER_PASS_KEY = 'user_password_storage';

        // ğŸ”‘ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù¾ÛŒØ´â€ŒÙØ±Ø¶
        const DEFAULT_ADMIN_PASSWORD = 'm2284147216'; 
        const DEFAULT_USER_PASSWORD = '123'; 
        
        // ğŸ”‘ Ø®ÙˆØ§Ù†Ø¯Ù† Ø±Ù…Ø²Ù‡Ø§ÛŒ Ø¹Ø¨ÙˆØ± Ø§Ø² LocalStorageØŒ ÛŒØ§ ØªÙ†Ø¸ÛŒÙ… Ù¾ÛŒØ´â€ŒÙØ±Ø¶
        let ADMIN_PASSWORD = localStorage.getItem(ADMIN_PASS_KEY) || DEFAULT_ADMIN_PASSWORD;
        let USER_PASSWORD = localStorage.getItem(USER_PASS_KEY) || DEFAULT_USER_PASSWORD;
        
        // Ø°Ø®ÛŒØ±Ù‡ Ø±Ù…Ø²Ù‡Ø§ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø§Ú¯Ø± Ù‡Ù†ÙˆØ² Ø¯Ø± LocalStorage Ù†Ø¨Ø§Ø´Ù†Ø¯
        if (!localStorage.getItem(ADMIN_PASS_KEY)) {
             localStorage.setItem(ADMIN_PASS_KEY, DEFAULT_ADMIN_PASSWORD);
             ADMIN_PASSWORD = DEFAULT_ADMIN_PASSWORD;
        }
        if (!localStorage.getItem(USER_PASS_KEY)) {
             localStorage.setItem(USER_PASS_KEY, DEFAULT_USER_PASSWORD);
             USER_PASSWORD = DEFAULT_USER_PASSWORD;
        }

        let members = JSON.parse(localStorage.getItem(DB_KEY)) || [];
        let monthlyArchives = JSON.parse(localStorage.getItem(ARCHIVE_KEY)) || [];
        
        let currentUserId = localStorage.getItem(USER_ID_KEY);
        let currentUser = members.find(m => m.id === currentUserId);
        
        let currentWinnerData;
        try { currentWinnerData = JSON.parse(localStorage.getItem(WINNER_KEY)); } catch (e) { currentWinnerData = null; }
        
        let activeArchiveMonth = null; 

        // **âš ï¸ Ù…Ù†Ø·Ù‚ ØªØ¨Ø¯ÛŒÙ„ Ø³Ø§Ø®ØªØ§Ø± Ù‚Ø¯ÛŒÙ…ÛŒ Ø¨Ù‡ Ø¬Ø¯ÛŒØ¯**
        members = members.map(m => {
            if (m.receipt !== undefined && m.receipt !== null && m.receipts === undefined) {
                m.receipts = [{ data: m.receipt, date: new Date().toLocaleString('fa-IR'), timestamp: Date.now() }];
                delete m.receipt;
            } else if (m.receipts === undefined) {
                 m.receipts = [];
            }
            if (m.status === undefined) {
                 m.status = 'pending'; 
            }
            if (m.nudgeCount === undefined) {
                 m.nudgeCount = 0;
            }
            return m;
        });
        save();

        // ğŸ ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ú¯Ø±ÙØªÙ† Ù†Ø§Ù… Ù…Ø§Ù‡ ÙØ§Ø±Ø³ÛŒ Ùˆ Ú©Ø¯ Ù…Ù†Ø­ØµØ± Ø¨Ù‡ ÙØ±Ø¯
        function getCurrentPersianMonthInfo() {
            // Ø§ÛŒÙ† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø³ØªÛŒ Ø¯Ø± Ø§Ø¨ØªØ¯Ø§ÛŒ Ù‡Ø± Ù…Ø§Ù‡ Ø¬Ø¯ÛŒØ¯ Ø¢Ù¾Ø¯ÛŒØª Ø´ÙˆØ¯!
            const currentYear = '1404'; 
            const currentMonthName = 'Ø¢Ø°Ø±';
            const currentMonthNumber = 9; 
            const monthCode = `${currentYear}-${currentMonthNumber}`;
            return { monthName: currentMonthName, year: currentYear, monthNumber: currentMonthNumber, monthCode };
        }
        
        // ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ù…ÛŒÙ„Ø§Ø¯ÛŒ (Date.now()) Ø¨Ù‡ Ø´Ù…Ø³ÛŒ Ø³Ø§Ø¯Ù‡
        function toPersianDate(timestamp) {
            if (!timestamp) return 'Ù†Ø§Ù…Ø´Ø®Øµ';
            const date = new Date(parseInt(timestamp));
            return date.toLocaleDateString('fa-IR', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }).replace('ØŒ', ' ');
        }


        // --- Save & Load ---
        function save() { 
            localStorage.setItem(DB_KEY, JSON.stringify(members)); 
            localStorage.setItem(ARCHIVE_KEY, JSON.stringify(monthlyArchives));
        }

        // --- Logic Functions ---

        // ğŸ”‘ ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯: ÙˆØ±ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¹Ù…ÙˆÙ…ÛŒ
        function checkUserPassword(e) {
            e.preventDefault();
            const inputPass = document.getElementById('userPassword').value;

            if (inputPass === USER_PASSWORD) {
                localStorage.setItem('userLoggedIn', 'true');
                document.getElementById('userLoginModal').style.display = 'none';
                document.getElementById('mainAppContainer').style.display = 'block';
                document.getElementById('countdownContainer').style.display = 'block';
                document.getElementById('mainNavBar').style.display = 'flex';
                showToast('ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ². Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯.');
                render(); 
            } else {
                showToast('âŒ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª.');
                document.getElementById('userPassword').value = '';
            }
        }
        
        // ğŸ”‘ ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯: ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¹Ù…ÙˆÙ…ÛŒ
        function changeUserPassword(e) {
             e.preventDefault();
             const newPass = document.getElementById('newUserPassword').value;
             
             if (newPass.length < 3) {
                 showToast('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ 3 Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø§Ø´Ø¯.');
                 return;
             }

             if (confirm(`Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¹Ù…ÙˆÙ…ÛŒ Ø±Ø§ Ø¨Ù‡ "${newPass}" ØªØºÛŒÛŒØ± Ù…ÛŒâ€ŒØ¯Ù‡ÛŒØ¯ØŸ`)) {
                 USER_PASSWORD = newPass;
                 localStorage.setItem(USER_PASS_KEY, newPass);
                 document.getElementById('newUserPassword').value = '';
                 // ÙÛŒÙ„Ø¯ placeholder Ø±Ø§ Ø¨Ù‡ Ø±ÙˆØ² Ø±Ø³Ø§Ù†ÛŒ Ú©Ù†ÛŒØ¯ ØªØ§ Ú©Ø§Ø±Ø¨Ø± Ø±Ù…Ø² Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ø¨Ø¨ÛŒÙ†Ø¯
                 document.getElementById('newUserPassword').placeholder = `Ø±Ù…Ø² ÙØ¹Ù„ÛŒ: ${newPass}`; 
                 showToast('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¹Ù…ÙˆÙ…ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØºÛŒÛŒØ± Ú©Ø±Ø¯.');
             }
        }
        
        // ğŸ”‘ ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯: ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª (Ø§Ø¯Ù…ÛŒÙ†)
        function changeAdminPassword(e) {
             e.preventDefault();
             const newPass = document.getElementById('newAdminPassword').value;
             
             if (newPass.length < 5) {
                 showToast('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø¯Ù…ÛŒÙ† Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ 5 Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø§Ø´Ø¯.');
                 return;
             }

             if (confirm(`Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø±Ø§ Ø¨Ù‡ "${newPass}" ØªØºÛŒÛŒØ± Ù…ÛŒâ€ŒØ¯Ù‡ÛŒØ¯ØŸ`)) {
                 ADMIN_PASSWORD = newPass;
                 localStorage.setItem(ADMIN_PASS_KEY, newPass);
                 document.getElementById('newAdminPassword').value = '';
                 // ÙÛŒÙ„Ø¯ placeholder Ø±Ø§ Ø¨Ù‡ Ø±ÙˆØ² Ø±Ø³Ø§Ù†ÛŒ Ú©Ù†ÛŒØ¯ ØªØ§ Ú©Ø§Ø±Ø¨Ø± Ø±Ù…Ø² Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ø¨Ø¨ÛŒÙ†Ø¯
                 document.getElementById('newAdminPassword').placeholder = `Ø±Ù…Ø² ÙØ¹Ù„ÛŒ: ${newPass}`;
                 showToast('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØºÛŒÛŒØ± Ú©Ø±Ø¯.');
             }
        }

        function render() {
            const list = document.getElementById('membersList');
            const empty = document.getElementById('emptyState');
            const btnJoin = document.getElementById('btnJoinNav');
            const profileCard = document.getElementById('sidebarProfileCard');
            const winnerProfileDiv = document.getElementById('currentWinnerProfile');
            
            list.innerHTML = '';
            profileCard.innerHTML = '';
            
            try {
                 currentWinnerData = JSON.parse(localStorage.getItem(WINNER_KEY));
            } catch (e) {
                 currentWinnerData = null;
            }
            
            if (currentWinnerData && currentWinnerData.name) {
                winnerProfileDiv.innerHTML = `
                    <div class="winner-profile">
                        <p class="month">ğŸ† Ø¨Ø±Ù†Ø¯Ù‡ Ø§Ø®ÛŒØ± (Ù…Ø§Ù‡ **${currentWinnerData.month}**)</p>
                        <h4>${currentWinnerData.name}</h4>
                        <p>ØªÙ„ÙÙ†: ${currentWinnerData.phone}</p>
                    </div>
                `;
            } else {
                 winnerProfileDiv.innerHTML = `<p style="font-size:0.9rem; color:#666; text-align:center;">Ù‡Ù†ÙˆØ² Ø¨Ø±Ù†Ø¯Ù‡ Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>`;
            }


            const approvedMembers = members.filter(m => m.status === 'pending' || m.status === 'paid' || m.status === 'awaiting_approval');

            currentUser = members.find(m => m.id === currentUserId);
            if (currentUser) {
                btnJoin.style.display = 'none'; 
                renderProfileCard(currentUser); 
            } else {
                btnJoin.style.display = 'inline-block'; 
            }

            if (approvedMembers.length === 0) {
                 if (!currentUser || currentUser.status !== 'new') {
                   empty.style.display = 'block';
                }
            } else {
                empty.style.display = 'none';
                
                approvedMembers.forEach(m => {
                    const isPaid = m.status === 'paid';
                    const isAwaitingApproval = m.status === 'awaiting_approval';
                    
                    const latestReceipt = m.receipts && m.receipts.length > 0 ? m.receipts.sort((a, b) => b.timestamp - a.timestamp)[0].data : null;
                    
                    let statusClass, statusText;

                    if (isPaid) {
                        statusClass = 'status-paid';
                        statusText = 'âœ… Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡';
                    } else if (isAwaitingApproval) {
                        statusClass = 'status-awaiting-approval'; 
                        statusText = 'â³ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ§ÛŒÛŒØ¯ ÙÛŒØ´';
                    } else { // pending
                        statusClass = 'status-unpaid';
                        statusText = 'âŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ú©Ø±Ø¯Ù‡';
                    }
                    
                    let actionButtons = '';
                    const isCurrentUser = currentUserId && m.id === currentUserId;

                    if (isCurrentUser) {
                        const viewReceiptBtn = latestReceipt ? 
                            `<button class="btn btn-receipt" onclick="viewReceiptForUser('${m.id}')">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø±Ø³ÛŒØ¯</button>` : '';
                        
                        if (m.status !== 'new') {
                             const uploadBtn = `<button class="btn btn-upload" onclick="openUpload('${m.id}')">Ø«Ø¨Øª/ÙˆÛŒØ±Ø§ÛŒØ´ ÙÛŒØ´</button>`;
                             actionButtons = `${uploadBtn} ${viewReceiptBtn}`;
                        } else {
                            actionButtons = `<button class="btn btn-disabled">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÛŒÛŒØ¯ Ø¹Ø¶ÙˆÛŒØª</button>`;
                        }
                    } else {
                        if (latestReceipt) {
                             actionButtons = `<button class="btn btn-receipt" onclick="viewReceiptForUser('${m.id}')">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø±Ø³ÛŒØ¯</button>`;
                        } else {
                             actionButtons = `<button class="btn btn-disabled">Ø±Ø³ÛŒØ¯ Ù†Ø¯Ø§Ø±Ø¯</button>`;
                        }
                        
                    }
                    
                    let finalActionRow = '';
                    let finalNudgeBtn = '';
                    
                    if (!isCurrentUser && m.status === 'pending') {
                        finalNudgeBtn = `
                            <button class="btn btn-nudge" onclick="sendNudge('${m.id}', '${m.name}')">
                                ğŸ”” ØªØ°Ú©Ø±
                                ${m.nudgeCount > 0 ? `<span class="nudge-count">${m.nudgeCount}</span>` : ''}
                            </button>
                        `;
                         finalActionRow = `<div style="display: flex; gap: 10px; flex-grow: 1;">${finalNudgeBtn} ${actionButtons}</div>`;

                    } else {
                        finalActionRow = actionButtons;
                    }


                    const card = document.createElement('div');
                    card.className = 'member-card';
                    card.innerHTML = `
                        <div class="member-header">
                            <div>
                                <div class="member-name">${m.name}</div>
                                <div class="member-phone">${m.phone}</div>
                            </div>
                            <div class="status-badge ${statusClass}">
                                ${statusText}
                            </div>
                        </div>
                        
                        <div class="action-row">
                            ${finalActionRow}
                        </div>
                    `;
                    list.appendChild(card);
                });
            }

            // 3. Ø¢Ù…Ø§Ø± Ø¹Ù…ÙˆÙ…ÛŒ
            document.getElementById('totalMembers').innerText = approvedMembers.length;
            const paidCount = approvedMembers.filter(m => m.status === 'paid').length;
            document.getElementById('totalFund').innerText = (paidCount * 2).toLocaleString('fa-IR') + ' M';
        }

        // ğŸš€ ØªØ§Ø¨Ø¹: Ø´Ù…Ø§Ø±Ø´ Ù…Ø¹Ú©ÙˆØ³ ØªØ§ Ù¾Ø§ÛŒØ§Ù† Ù…Ø§Ù‡ Ø¢Ø°Ø± ğŸš€
        function startCountdownTimer() {
            // âš ï¸ ØªØ§Ø±ÛŒØ® Ù‡Ø¯Ù: Dec 22, 2025 00:00:00 (Ø¨Ø§ÛŒØ¯ Ø¯Ø± Ø§Ø¨ØªØ¯Ø§ÛŒ Ù‡Ø± Ø¯ÙˆØ±Ù‡ Ø¬Ø¯ÛŒØ¯ Ø¢Ù¾Ø¯ÛŒØª Ø´ÙˆØ¯!)
            const targetDate = new Date('Dec 22, 2025 00:00:00').getTime(); 

            const interval = setInterval(() => {
                const now = new Date().getTime();
                const distance = targetDate - now;

                if (distance < 0) {
                    clearInterval(interval);
                    document.getElementById('countdownTimer').innerHTML = '<h3 style="margin:0; text-align:center;">Ø²Ù…Ø§Ù† Ù‚Ø±Ø¹Ù‡â€ŒÚ©Ø´ÛŒ Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯!</h3>';
                    if (localStorage.getItem('adminLoggedIn') === 'true') {
                        renderAdminDashboard(); 
                    }
                    return;
                }

                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                document.getElementById('timerDays').innerText = String(days).padStart(2, '0');
                document.getElementById('timerHours').innerText = String(hours).padStart(2, '0');
                document.getElementById('timerMinutes').innerText = String(minutes).padStart(2, '0');
                document.getElementById('timerSeconds').innerText = String(seconds).padStart(2, '0');
            }, 1000);
        }
        
        // --- ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ ---
        function renderProfileCard(user) {
            const profileCard = document.getElementById('sidebarProfileCard');
            let statusEmoji = 'ğŸ‘¤';
            let statusText = 'ÙˆØ¶Ø¹ÛŒØª: Ù†Ø§Ù…Ø´Ø®Øµ';
            let cardClass = '';

            if (user.status === 'paid') {
                statusEmoji = 'ğŸ’°';
                statusText = 'ÙˆØ¶Ø¹ÛŒØª: **Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡**';
            } else if (user.status === 'pending') {
                statusEmoji = 'â³';
                statusText = 'ÙˆØ¶Ø¹ÛŒØª: **Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ù¾Ø±Ø¯Ø§Ø®Øª**';
            } else if (user.status === 'new') {
                 statusEmoji = 'âœ‹';
                 statusText = 'ÙˆØ¶Ø¹ÛŒØª: **Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÛŒÛŒØ¯ Ù…Ø¯ÛŒØ±**';
                 cardClass = 'status-new'; 
            } else if (user.status === 'awaiting_approval') {
                 statusEmoji = 'â³';
                 statusText = 'ÙˆØ¶Ø¹ÛŒØª: **ÙÛŒØ´ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡ (Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÛŒÛŒØ¯ Ù…Ø¯ÛŒØ±)**';
                 cardClass = 'status-awaiting'; 
            }
            
            profileCard.innerHTML = `
                <div class="user-profile-card ${cardClass}">
                    <div class="profile-icon">${statusEmoji}</div>
                    <h3>${user.name}</h3>
                    <p>${user.phone}</p>
                    <p style="margin-top: 10px; font-weight: bold; font-size: 0.95rem;">${statusText}</p>
                </div>
            `;
        }
        
        function handleJoin(e) {
            e.preventDefault();
            const name = document.getElementById('joinName').value;
            const phone = document.getElementById('joinPhone').value;
            
            if (currentUserId) {
                showToast('Ø´Ù…Ø§ Ù‚Ø¨Ù„Ø§Ù‹ Ø¹Ø¶Ùˆ Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯!');
                closeModal('joinModal');
                return;
            }

            const newId = Date.now().toString();

            const newMember = {
                id: newId,
                name,
                phone,
                status: 'new', 
                receipts: [], 
                nudgeCount: 0
            };

            members.push(newMember);
            
            currentUserId = newId;
            localStorage.setItem(USER_ID_KEY, newId);
            
            save(); 
            render(); 
            closeModal('joinModal');
            document.getElementById('joinName').value = '';
            document.getElementById('joinPhone').value = '';
            
            showToast(`Ø«Ø¨Øª Ù†Ø§Ù… Ø´Ù…Ø§ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯. Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø´Ù…Ø§ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÛŒÛŒØ¯ Ù…Ø¯ÛŒØ± Ø§Ø³Øª. ğŸ¤š`);
        }

        function sendNudge(id, name) {
            const index = members.findIndex(m => m.id === id);
            if (index !== -1 && members[index].status === 'pending') { 
                members[index].nudgeCount = (members[index].nudgeCount || 0) + 1;
                save();
                render();
                if (document.getElementById('adminContent') && document.getElementById('adminContent').style.display === 'block') {
                    renderAdminDashboard();
                }
                showToast(`Ù¾ÛŒØ§Ù… ØªØ°Ú©Ø± Ø¨Ù‡ Ú¯ÙˆØ´ÛŒ ${name} Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ ğŸ“²`);
            } else {
                 showToast('Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± ÙˆØ¶Ø¹ÛŒØª Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ§ÛŒÛŒØ¯ ÛŒØ§ Ù¾Ø±Ø¯Ø§Ø®Øª Ù‚Ø±Ø§Ø± Ù†Ø¯Ø§Ø±Ø¯ Ú©Ù‡ Ø¨ØªÙˆØ§Ù† Ø¨Ù‡ Ø§Ùˆ ØªØ°Ú©Ø± Ø¯Ø§Ø¯.');
            }
        }

        function handleUpload(e) {
            e.preventDefault();
            const id = document.getElementById('uploadUserId').value;
            const fileInput = document.getElementById('uploadFile');
            const file = fileInput.files[0];
            
            if (!file) return;

            if (id !== currentUserId) {
                 showToast('âŒ Ø´Ù…Ø§ ÙÙ‚Ø· Ù…Ø¬Ø§Ø² Ø¨Ù‡ Ø¢Ù¾Ù„ÙˆØ¯ ÙÛŒØ´ Ø¨Ø±Ø§ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø®ÙˆØ¯ Ù‡Ø³ØªÛŒØ¯.');
                 closeModal('uploadModal');
                 return;
            }

            const idx = members.findIndex(m => m.id === id);

            if (idx !== -1) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const newReceipt = {
                        data: ev.target.result,
                        timestamp: Date.now() 
                    };
                    
                    members[idx].receipts.push(newReceipt);
                    members[idx].status = 'awaiting_approval'; 
                    members[idx].nudgeCount = 0;
                    
                    save(); 
                    render(); 
                    closeModal('uploadModal');
                    fileInput.value = ''; 
                    showToast('ÙÛŒØ´ Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ù…Ù†ØªØ¸Ø± ØªØ£ÛŒÛŒØ¯ Ù…Ø¯ÛŒØ± Ø¨Ø§Ø´ÛŒØ¯. â³');
                }
                reader.readAsDataURL(file);
            }
        }

        // --- Ù…Ù†Ø·Ù‚ Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ† ---

        function showAdminPanel() {
            if (localStorage.getItem('adminLoggedIn') !== 'true') {
                 document.getElementById('mainAppContainer').style.display = 'none';
                 document.getElementById('btnJoinNav').style.display = 'none'; 
                 document.getElementById('countdownContainer').style.display = 'none'; 
                 document.getElementById('mainNavBar').style.display = 'none';
                 document.getElementById('adminPanel').style.display = 'block';
                 document.getElementById('passwordForm').style.display = 'block';
                 document.getElementById('adminContent').style.display = 'none';
                 document.getElementById('adminPassword').value = '';
            } else {
                 document.getElementById('mainAppContainer').style.display = 'none';
                 document.getElementById('btnJoinNav').style.display = 'none'; 
                 document.getElementById('countdownContainer').style.display = 'none'; 
                 document.getElementById('mainNavBar').style.display = 'none';
                 document.getElementById('adminPanel').style.display = 'block';
                 document.getElementById('passwordForm').style.display = 'none';
                 document.getElementById('adminContent').style.display = 'block';
                 // Ø¢Ù¾Ø¯ÛŒØª Ú©Ø±Ø¯Ù† Ø±Ù…Ø²Ù‡Ø§ÛŒ Ø¹Ø¨ÙˆØ± Ø¯Ø± ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾Ù†Ù„
                 document.getElementById('newAdminPassword').placeholder = `Ø±Ù…Ø² ÙØ¹Ù„ÛŒ: ${ADMIN_PASSWORD}`;
                 document.getElementById('newUserPassword').placeholder = `Ø±Ù…Ø² ÙØ¹Ù„ÛŒ: ${USER_PASSWORD}`;
                 activeArchiveMonth = null; 
                 renderAdminDashboard(); 
            }
        }

        function hideAdminPanel() {
            localStorage.removeItem('adminLoggedIn'); 
            document.getElementById('adminPanel').style.display = 'none';
            // Ú†Ú© Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ù„Ø§Ú¯ÛŒÙ† Ø¨ÙˆØ¯ØŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ù‡ÛŒÙ…
            if (localStorage.getItem('userLoggedIn') === 'true') {
                document.getElementById('mainAppContainer').style.display = 'block';
                document.getElementById('countdownContainer').style.display = 'block';
                document.getElementById('mainNavBar').style.display = 'flex';
                render(); 
            } else {
                 document.getElementById('userLoginModal').style.display = 'flex';
            }
        }


        function checkAdminPassword(e) {
            e.preventDefault();
            const inputPass = document.getElementById('adminPassword').value;

            if (inputPass === ADMIN_PASSWORD) {
                localStorage.setItem('adminLoggedIn', 'true');
                document.getElementById('passwordForm').style.display = 'none';
                document.getElementById('adminContent').style.display = 'block';
                // Ø¢Ù¾Ø¯ÛŒØª Ú©Ø±Ø¯Ù† Ø±Ù…Ø²Ù‡Ø§ÛŒ Ø¹Ø¨ÙˆØ± Ø¯Ø± ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾Ù†Ù„
                document.getElementById('newAdminPassword').placeholder = `Ø±Ù…Ø² ÙØ¹Ù„ÛŒ: ${ADMIN_PASSWORD}`;
                document.getElementById('newUserPassword').placeholder = `Ø±Ù…Ø² ÙØ¹Ù„ÛŒ: ${USER_PASSWORD}`;
                showToast('ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ²! Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯.');
                activeArchiveMonth = null;
                renderAdminDashboard();
            } else {
                showToast('âŒ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª.');
                document.getElementById('adminPassword').value = '';
            }
        }
        
        function scrollToTable() {
            const table = document.getElementById('currentMonthTitle');
            if (table) {
                table.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function renderAdminDashboard() {
            const currentMonthInfo = getCurrentPersianMonthInfo();
            
            const paidCount = members.filter(m => m.status === 'paid').length;
            const awaitingPaymentOrNew = members.filter(m => m.status === 'new' || m.status === 'awaiting_approval').length;
            const newMembersCount = members.filter(m => m.status === 'new').length;
            
            const totalFund = (paidCount * 2).toLocaleString('fa-IR') + ' M';
            
            document.getElementById('currentMonthName').innerText = `${currentMonthInfo.monthName} ${currentMonthInfo.year}`;
            document.getElementById('adminPaidCount').innerText = paidCount;
            document.getElementById('adminAwaitingCount').innerText = awaitingPaymentOrNew;
            document.getElementById('adminTotalFund').innerText = totalFund;

            const notificationCard = document.getElementById('adminNotificationCard');
            const newMemberCountSpan = document.getElementById('newMemberCount');

            if (newMembersCount > 0 && activeArchiveMonth === null) {
                newMemberCountSpan.innerText = newMembersCount;
                notificationCard.style.display = 'block';
            } else {
                notificationCard.style.display = 'none';
            }
            
            const archiveContainer = document.getElementById('monthlyArchivesContainer');
            archiveContainer.innerHTML = '';
            
            renderArchiveBox(currentMonthInfo.monthCode, `${currentMonthInfo.monthName} (Ø¬Ø§Ø±ÛŒ)`, paidCount, true);
            
            monthlyArchives.slice().reverse().forEach(archive => {
                if (archive.monthCode !== currentMonthInfo.monthCode) {
                    renderArchiveBox(
                        archive.monthCode, 
                        `${archive.monthName} ${archive.year} ğŸ† (${archive.winnerName})`, 
                        archive.paidCount,
                        false 
                    );
                }
            });

            renderAdminTable(activeArchiveMonth);
        }
        
        function renderArchiveBox(monthCode, title, paidCount, isCurrent = false) {
            const container = document.getElementById('monthlyArchivesContainer');
             
            const isActive = (isCurrent && activeArchiveMonth === null) || (activeArchiveMonth === monthCode);
            
            const box = document.createElement('div');
            box.className = `monthly-archive-box ${isCurrent ? 'current-month' : ''} ${isActive ? 'active' : ''}`;
            
            let onclickHandler;
            if(isCurrent) {
                onclickHandler = `showMonthlySummaryForCurrentMonth('${monthCode}')`;
            } else {
                onclickHandler = `showMonthlySummary('${monthCode}')`;
                // Ø§Ú¯Ø± Ø±ÙˆÛŒ Ø¨Ø§Ú©Ø³ Ø¢Ø±Ø´ÛŒÙˆ ÙØ¹Ø§Ù„ Ú©Ù„ÛŒÚ© Ú©Ù†Ø¯ØŒ Ø¬Ø¯ÙˆÙ„ Ø±Ø§ Ø¨Ù‡ Ø¢Ø±Ø´ÛŒÙˆ ÙÛŒÙ„ØªØ± Ù…ÛŒâ€ŒÚ©Ù†Ø¯
                if (activeArchiveMonth === monthCode) { 
                   onclickHandler = `filterAdminTable('${monthCode}')`;
                }
            }
            box.setAttribute('onclick', onclickHandler);
            
            box.innerHTML = `
               <div class="archive-header">
                   <span class="archive-month">${title}</span>
                   <span class="archive-stats">Ù¾Ø±Ø¯Ø§Ø®ØªÛŒâ€ŒÙ‡Ø§: ${paidCount} Ù†ÙØ±</span>
               </div>
            `;
            container.appendChild(box);
        }
        
        function showMonthlySummaryForCurrentMonth(monthCode) {
             const currentMonthInfo = getCurrentPersianMonthInfo();
             const paidMembers = members.filter(m => m.status === 'paid');
             const paidCount = paidMembers.length;
             const totalFund = (paidCount * 2).toLocaleString('fa-IR') + ' Ù…ÛŒÙ„ÛŒÙˆÙ† ØªÙˆÙ…Ø§Ù†';
             
             document.getElementById('summaryTitle').innerText = `Ø®Ù„Ø§ØµÙ‡ Ù…Ø§Ù‡ ${currentMonthInfo.monthName} (Ø¬Ø§Ø±ÛŒ) ${currentMonthInfo.year}`;

             const contentDiv = document.getElementById('summaryContent');
             
             let paidListHTML = paidMembers.length > 0 ? '' : '<p style="text-align:center; color:#999;">ÙØ±Ø¯ÛŒ Ø¯Ø± Ø§ÛŒÙ† Ù…Ø§Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÙˆÙÙ‚ Ù†Ø¯Ø§ÙˆØ³Ø§Ø´ØªÙ‡ Ø§Ø³Øª.</p>';

             let shareText = `**ğŸ“Š Ø®Ù„Ø§ØµÙ‡ ØµÙ†Ø¯ÙˆÙ‚ Ù‚Ø±Ø¶â€ŒØ§Ù„Ø­Ø³Ù†Ù‡ Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡ **\n*Ù…Ø§Ù‡: ${currentMonthInfo.monthName} (Ø¬Ø§Ø±ÛŒ) ${currentMonthInfo.year}*\n\n`;
             shareText += `ğŸ† Ø¨Ø±Ù†Ø¯Ù‡ Ù…Ø§Ù‡: **Ù‡Ù†ÙˆØ² Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡**\n`;
             shareText += `âœ… ØªØ¹Ø¯Ø§Ø¯ Ù¾Ø±Ø¯Ø§Ø®ØªÛŒâ€ŒÙ‡Ø§: ${paidCount} Ù†ÙØ±\n`;
             shareText += `ğŸ’° Ù…Ø¨Ù„Øº Ú©Ù„ Ø¬Ù…Ø¹ Ø´Ø¯Ù‡: ${totalFund}\n\n`;
             shareText += `--- Ù„ÛŒØ³Øª Ù¾Ø±Ø¯Ø§Ø®Øª Ú©Ù†Ù†Ø¯Ú¯Ø§Ù† ---\n`;


             paidMembers.forEach((member, index) => {
                 const lastReceipt = member.receipts.sort((a, b) => b.timestamp - a.timestamp)[0];
                 const paymentDate = lastReceipt ? toPersianDate(lastReceipt.timestamp) : '---';
                 
                 const receiptButton = member.receipts.length > 0 
                     ? `<button class="btn-admin" style="background:#4f46e5; color:white; padding: 4px 8px; font-size: 0.75rem;" onclick="showAllReceipts('${member.id}', false); event.stopPropagation();">ğŸ‘€ ÙÛŒØ´</button>` 
                     : `<span style="color:#9ca3af; font-size: 0.75rem;">ÙÛŒØ´ Ù†Ø¯Ø§Ø±Ø¯</span>`;

                 paidListHTML += `
                     <div class="paid-item">
                         <span class="paid-item-name">ğŸ‘¤ ${member.name}</span>
                         <div style="display:flex; gap: 8px; align-items:center;">
                             <span class="paid-item-date">ğŸ’³ ${paymentDate}</span>
                             ${receiptButton} 
                         </div>
                     </div>
                 `;
                  
                 shareText += `${index + 1}. ${member.name} (Ù¾Ø±Ø¯Ø§Ø®Øª: ${paymentDate})\n`;
             });
             
             shareText += `\n\nØ¨Ø§ ØªØ´Ú©Ø± Ø§Ø² Ù‡Ù…Ù‡ Ø§Ø¹Ø¶Ø§ÛŒ ØµÙ†Ø¯ÙˆÙ‚ ğŸ™`;


             contentDiv.innerHTML = `
                 <div class="admin-stat-grid" style="margin-bottom: 20px;">
                     <div class="summary-stat" style="border-right: 5px solid #6b7280;">
                         <h5>Ø¨Ø±Ù†Ø¯Ù‡ Ù…Ø§Ù‡</h5>
                         <p style="font-size: 1.1rem; font-weight: bold; color: #6b7280;">Ù‡Ù†ÙˆØ² Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡</p>
                     </div>
                     <div class="summary-stat" style="border-right: 5px solid var(--green-text);">
                         <h5>ØªØ¹Ø¯Ø§Ø¯ Ù¾Ø±Ø¯Ø§Ø®ØªÛŒâ€ŒÙ‡Ø§</h5>
                         <p style="font-size: 1.1rem; font-weight: bold; color: var(--green-text);">${paidCount} Ù†ÙØ±</p>
                     </div>
                     <div class="summary-stat" style="border-right: 5px solid var(--primary);">
                          <h5>Ù…Ø¨Ù„Øº Ø¬Ù…Ø¹ Ø´Ø¯Ù‡</h5>
                         <p style="font-size: 1.1rem; font-weight: bold; color: var(--primary);">${totalFund}</p>
                     </div>
                 </div>
                 
                 <h4>Ù„ÛŒØ³Øª Ø§ÙØ±Ø§Ø¯ Ù¾Ø±Ø¯Ø§Ø®Øª Ú©Ù†Ù†Ø¯Ù‡:</h4>
                 <div class="paid-list">
                     ${paidListHTML}
                 </div>
                 
                 <hr style="margin-top: 20px;">
                 
                 <button class="btn-full" style="background:#10b981; margin-bottom: 10px;" 
                         onclick="copyShareText(\`${shareText.replace(/\n/g, '\\n').replace(/'/g, "\\'")}\`)">
                     ğŸ”— Ø§Ø´ØªØ±Ø§Ú© Ø®Ù„Ø§ØµÙ‡ (Ú©Ù¾ÛŒ Ù…ØªÙ†)
                 </button>

                 <p style="text-align:center; font-size:0.9rem; color:#6b7280;">Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª Ø¬Ø¯ÙˆÙ„ Ø§Ø¹Ø¶Ø§ÛŒ Ø§ÛŒÙ† Ù…Ø§Ù‡ØŒ <a href="#" onclick="filterAdminTable(null); closeModal('summaryModal');">Ø§ÛŒÙ†Ø¬Ø§ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯</a>.</p>
             `;

             openModal('summaryModal');
        }


        function showMonthlySummary(monthCode) {
            const archive = monthlyArchives.find(a => a.monthCode === monthCode);
            if (!archive) {
                showToast('Ø®Ø·Ø§: Ø³ÙˆØ§Ø¨Ù‚ Ø§ÛŒÙ† Ù…Ø§Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯.');
                return;
            }

            document.getElementById('summaryTitle').innerText = `Ø®Ù„Ø§ØµÙ‡ Ù…Ø§Ù‡ ${archive.monthName} ${archive.year}`;
            
            const contentDiv = document.getElementById('summaryContent');
            const totalFund = (archive.paidCount * 2).toLocaleString('fa-IR') + ' Ù…ÛŒÙ„ÛŒÙˆÙ† ØªÙˆÙ…Ø§Ù†';
            
            const paidMembers = archive.members.filter(m => m.status === 'paid');
            let paidListHTML = paidMembers.length > 0 ? '' : '<p style="text-align:center; color:#999;">ÙØ±Ø¯ÛŒ Ø¯Ø± Ø§ÛŒÙ† Ù…Ø§Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÙˆÙÙ‚ Ù†Ø¯Ø§Ø´ØªÙ‡ Ø§Ø³Øª.</p>';

            let shareText = `**ğŸ“Š Ø®Ù„Ø§ØµÙ‡ ØµÙ†Ø¯ÙˆÙ‚ Ù‚Ø±Ø¶â€ŒØ§Ù„Ø­Ø³Ù†Ù‡ Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡ **\n*Ù…Ø§Ù‡: ${archive.monthName} ${archive.year}*\n\n`;
            shareText += `ğŸ† Ø¨Ø±Ù†Ø¯Ù‡ Ù…Ø§Ù‡: ${archive.winnerName || 'Ù†Ø§Ù…Ø´Ø®Øµ'}\n`;
            shareText += `âœ… ØªØ¹Ø¯Ø§Ø¯ Ù¾Ø±Ø¯Ø§Ø®ØªÛŒâ€ŒÙ‡Ø§: ${archive.paidCount} Ù†ÙØ±\n`;
            shareText += `ğŸ’° Ù…Ø¨Ù„Øº Ú©Ù„ Ø¬Ù…Ø¹ Ø´Ø¯Ù‡: ${totalFund}\n\n`;
            shareText += `--- Ù„ÛŒØ³Øª Ù¾Ø±Ø¯Ø§Ø®Øª Ú©Ù†Ù†Ø¯Ú¯Ø§Ù† ---\n`;


            paidMembers.forEach((member, index) => {
                const lastReceipt = member.receipts.sort((a, b) => b.timestamp - a.timestamp)[0];
                const paymentDate = lastReceipt ? toPersianDate(lastReceipt.timestamp) : '---';
                
                const receiptButton = member.receipts.length > 0 
                    ? `<button class="btn-admin" style="background:#4f46e5; color:white; padding: 4px 8px; font-size: 0.75rem;" onclick="showAllReceipts('${member.id}', true, '${monthCode}'); event.stopPropagation();">ğŸ‘€ ÙÛŒØ´</button>` 
                    : `<span style="color:#9ca3af; font-size: 0.75rem;">ÙÛŒØ´ Ù†Ø¯Ø§Ø±Ø¯</span>`;

                paidListHTML += `
                    <div class="paid-item">
                        <span class="paid-item-name">ğŸ‘¤ ${member.name}</span>
                        <div style="display:flex; gap: 8px; align-items:center;">
                             <span class="paid-item-date">ğŸ’³ ${paymentDate}</span>
                             ${receiptButton} 
                        </div>
                    </div>
                `;
                 
                shareText += `${index + 1}. ${member.name} (Ù¾Ø±Ø¯Ø§Ø®Øª: ${paymentDate})\n`;
            });
            
            shareText += `\n\nØ¨Ø§ ØªØ´Ú©Ø± Ø§Ø² Ù‡Ù…Ù‡ Ø§Ø¹Ø¶Ø§ÛŒ ØµÙ†Ø¯ÙˆÙ‚ ğŸ™`;


            contentDiv.innerHTML = `
                <div class="admin-stat-grid" style="margin-bottom: 20px;">
                    <div class="summary-stat" style="border-right: 5px solid var(--winner-color);">
                        <h5>Ø¨Ø±Ù†Ø¯Ù‡ Ù…Ø§Ù‡</h5>
                        <p style="font-size: 1.1rem; font-weight: bold; color: var(--winner-color);">${archive.winnerName || 'Ù†Ø§Ù…Ø´Ø®Øµ'}</p>
                    </div>
                    <div class="summary-stat" style="border-right: 5px solid var(--green-text);">
                        <h5>ØªØ¹Ø¯Ø§Ø¯ Ù¾Ø±Ø¯Ø§Ø®ØªÛŒâ€ŒÙ‡Ø§</h5>
                        <p style="font-size: 1.1rem; font-weight: bold; color: var(--green-text);">${archive.paidCount} Ù†ÙØ±</p>
                    </div>
                    <div class="summary-stat" style="border-right: 5px solid var(--primary);">
                         <h5>Ù…Ø¨Ù„Øº Ø¬Ù…Ø¹ Ø´Ø¯Ù‡</h5>
                        <p style="font-size: 1.1rem; font-weight: bold; color: var(--primary);">${totalFund}</p>
                    </div>
                </div>
                
                <h4>Ù„ÛŒØ³Øª Ø§ÙØ±Ø§Ø¯ Ù¾Ø±Ø¯Ø§Ø®Øª Ú©Ù†Ù†Ø¯Ù‡:</h4>
                <div class="paid-list">
                    ${paidListHTML}
                </div>
                
                <hr style="margin-top: 20px;">
                
                <button class="btn-full" style="background:#10b981; margin-bottom: 10px;" 
                        onclick="copyShareText(\`${shareText.replace(/\n/g, '\\n').replace(/'/g, "\\'")}\`)">
                    ğŸ”— Ø§Ø´ØªØ±Ø§Ú© Ø®Ù„Ø§ØµÙ‡ (Ú©Ù¾ÛŒ Ù…ØªÙ†)
                </button>

                <p style="text-align:center; font-size:0.9rem; color:#6b7280;">Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª Ø¬Ø¯ÙˆÙ„ Ø§Ø¹Ø¶Ø§ÛŒ Ø§ÛŒÙ† Ù…Ø§Ù‡ØŒ <a href="#" onclick="filterAdminTable('${monthCode}'); closeModal('summaryModal');">Ø§ÛŒÙ†Ø¬Ø§ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯</a>.</p>
            `;

            openModal('summaryModal');
        }

        function filterAdminTable(monthCode) {
            activeArchiveMonth = monthCode;
            renderAdminDashboard(); 
        }

        function renderAdminTable(monthCode = null) {
            const tbody = document.getElementById('adminMembersTableBody');
            tbody.innerHTML = '';
            
            let listToRender;
            let titleText;

            if (monthCode === null) {
                listToRender = members;
                titleText = `Ø¬Ø¯ÙˆÙ„ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø¹Ø¶Ø§ÛŒ Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ (${getCurrentPersianMonthInfo().monthName})`;
                document.getElementById('currentMonthTitle').style.color = '#111';
            } else {
                const archive = monthlyArchives.find(a => a.monthCode === monthCode);
                if (!archive) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Ø³ÙˆØ§Ø¨Ù‚ Ø§ÛŒÙ† Ù…Ø§Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯.</td></tr>';
                    return;
                }
                listToRender = archive.members;
                titleText = `Ø¬Ø¯ÙˆÙ„ Ø³ÙˆØ§Ø¨Ù‚ ${archive.monthName} ${archive.year} (Ø¨Ø±Ù†Ø¯Ù‡: ${archive.winnerName})`;
                document.getElementById('currentMonthTitle').style.color = '#dc2626'; 
            }
            
            document.getElementById('currentMonthTitle').innerText = titleText;

            const sortedList = listToRender.sort((a, b) => {
                const statusOrder = ['new', 'awaiting_approval', 'pending', 'paid'];
                const statusA = statusOrder.indexOf(a.status);
                const statusB = statusOrder.indexOf(b.status);
                
                if (statusA !== statusB) {
                    return statusA - statusB;
                }
                return (a.name > b.name) ? 1 : -1;
            });
            
            const isArchiveView = monthCode !== null;


            sortedList.forEach(m => {
                let statusText = '';
                let buttonActions = '';
                let rowClass = '';
                const receiptCount = m.receipts ? m.receipts.length : 0;

                if (m.status === 'new') {
                    statusText = 'ğŸŸ¡ Ø¹Ø¶ÙˆÛŒØª Ø¬Ø¯ÛŒØ¯ (ØªØ£ÛŒÛŒØ¯ Ø´ÙˆØ¯)';
                    rowClass = 'pending-row';
                    if (!isArchiveView) {
                        buttonActions = `<button class="btn-admin btn-verify-member" onclick="verifyMember('${m.id}', '${m.name}')">âœ”ï¸ ØªØ£ÛŒÛŒØ¯ Ø¹Ø¶ÙˆÛŒØª</button>`;
                    }
                } else if (m.status === 'awaiting_approval') {
                    statusText = 'ğŸŸ  ÙÛŒØ´ ÙˆØ§Ø±ÛŒØ²ÛŒ (ØªØ£ÛŒÛŒØ¯ Ø´ÙˆØ¯)';
                    rowClass = 'pending-row';
                    if (!isArchiveView) {
                         buttonActions = `<button class="btn-admin btn-verify-payment" onclick="verifyPayment('${m.id}')">ğŸ’° ØªØ£ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª</button>`;
                    }
                } else if (m.status === 'paid') {
                    statusText = 'âœ… Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡';
                } else { // status === 'pending'
                    statusText = 'âŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ú©Ø±Ø¯Ù‡';
                    if (!isArchiveView) {
                         buttonActions = `<button class="btn-admin" style="background:#f3f4f6; color:#374151;" onclick="sendNudge('${m.id}', '${m.name}')">ğŸ”” ØªØ°Ú©Ø± (${m.nudgeCount || 0})</button>`;
                    }
                }
                
                let receiptBtn = '';
                if (receiptCount > 0) {
                    receiptBtn = `
                        <a href="#" class="btn-admin" style="background:var(--primary); color:white;" onclick="showAllReceipts('${m.id}', ${isArchiveView}, '${monthCode}')">ğŸ‘€ ${receiptCount} ÙÛŒØ´</a>
                    `;
                    if (m.status === 'awaiting_approval' && !isArchiveView) {
                         buttonActions = `<button class="btn-admin btn-verify-payment" onclick="verifyPayment('${m.id}')">ğŸ’° ØªØ£ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª</button>` + receiptBtn;
                    } else {
                         buttonActions += receiptBtn;
                    }
                } else if (m.status !== 'new') { 
                    receiptBtn = `<span style="font-size:0.8rem; color:#666;">ÙÛŒØ´ Ù†Ø¯Ø§Ø±Ø¯</span>`;
                     if (m.status === 'new' && !isArchiveView) {
                         buttonActions = `<button class="btn-admin btn-verify-member" onclick="verifyMember('${m.id}', '${m.name}')">âœ”ï¸ ØªØ£ÛŒÛŒØ¯ Ø¹Ø¶ÙˆÛŒØª</button>`;
                     }
                }
                
                
                let winnerBtn = '';
                if (!isArchiveView && (m.status === 'paid' || m.status === 'pending')) {
                     winnerBtn = `
                        <button class="btn-admin btn-select-winner" onclick="selectWinner('${m.id}')">ğŸ† Ø¨Ø±Ù†Ø¯Ù‡</button>
                    `;
                }
                
                const deleteBtn = `<button class="btn-admin btn-delete-member" onclick="deleteMember('${m.id}', '${m.name}')">Ø­Ø°Ù</button>`;


                const row = document.createElement('tr');
                row.className = rowClass;
                
                row.innerHTML = `
                    <td>${m.name}</td>
                    <td>${m.phone}</td>
                    <td style="color:${m.status === 'paid' ? '#15803d' : (m.status === 'pending' ? '#b91c1c' : '#a16207')}; font-weight: bold;">${statusText}</td>
                    <td>${receiptCount}</td>
                    <td>${m.nudgeCount || 0}</td>
                    <td style="gap: 5px;">
                        ${buttonActions}
                        ${winnerBtn}
                        ${deleteBtn}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function selectWinner(id) {
            const winner = members.find(m => m.id === id);
            const currentMonthInfo = getCurrentPersianMonthInfo();
            const paidCount = members.filter(m => m.status === 'paid').length;
            
             if(!winner) {
                showToast('Ø®Ø·Ø§: Ø¹Ø¶Ùˆ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯.');
                return;
             }

             if(confirm(`Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ${winner.name} Ø±Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø¨Ø±Ù†Ø¯Ù‡ Ø¬Ø¯ÛŒØ¯ Ù…Ø§Ù‡ ${currentMonthInfo.monthName} Ø§Ø¹Ù„Ø§Ù… Ú©Ù†ÛŒØ¯ØŸ (Ø§ÛŒÙ† Ú©Ø§Ø± Ø¨Ø§Ø¹Ø« Ø¢Ø±Ø´ÛŒÙˆ Ø´Ø¯Ù† Ù…Ø§Ù‡ Ùˆ Ø±ÛŒØ³Øª Ø´Ø¯Ù† Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ù…Ø§Ù‡ Ø¬Ø¯ÛŒØ¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯.)`)) {
                
                const winnerData = {
                    name: winner.name,
                    phone: winner.phone,
                    month: currentMonthInfo.monthName
                };
                localStorage.setItem(WINNER_KEY, JSON.stringify(winnerData));
                currentWinnerData = winnerData;
                
                const archiveRecord = {
                    monthCode: currentMonthInfo.monthCode,
                    monthName: currentMonthInfo.monthName,
                    year: currentMonthInfo.year,
                    paidCount: paidCount,
                    winnerName: winner.name,
                    members: JSON.parse(JSON.stringify(members)) 
                };
                
                monthlyArchives.push(archiveRecord);
                
                members = members.map(m => {
                    if (m.status !== 'new') { 
                        m.status = 'pending'; 
                        m.nudgeCount = 0;
                        m.receipts = []; 
                    } 
                    return m;
                });
                
                save();
                render(); 
                activeArchiveMonth = null;
                renderAdminDashboard();
                startCountdownTimer(); 
                showToast(`ğŸ† Ù…Ø§Ù‡ ${currentMonthInfo.monthName} Ø¢Ø±Ø´ÛŒÙˆ Ø´Ø¯. Ø¨Ø±Ù†Ø¯Ù‡: ${winner.name}. ØªÙ…Ø§Ù… Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ Ø±ÛŒØ³Øª Ø´Ø¯Ù†Ø¯ Ùˆ Ù…Ø§Ù‡ Ø¬Ø¯ÛŒØ¯ Ø´Ø±ÙˆØ¹ Ø´Ø¯.`);
             }
        }


        // --- ØªÙˆØ§Ø¨Ø¹ Ø§Ú©Ø´Ù† Ø§Ø¯Ù…ÛŒÙ† ---

        function verifyMember(id, name) {
            if(confirm(`Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¹Ø¶ÙˆÛŒØª ${name} Ø±Ø§ ØªØ£ÛŒÛŒØ¯ Ú©Ù†ÛŒØ¯ØŸ`)) {
                const index = members.findIndex(m => m.id === id);
                if (index !== -1) {
                    members[index].status = 'pending'; 
                    save();
                    if (members[index].id === currentUserId) {
                        currentUser = members[index];
                    }
                    render(); 
                    renderAdminDashboard(); 
                    showToast(`âœ”ï¸ Ø¹Ø¶ÙˆÛŒØª ${name} ØªØ£ÛŒÛŒØ¯ Ø´Ø¯ Ùˆ Ø¯Ø± Ù„ÛŒØ³Øª Ø§ØµÙ„ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.`);
                }
            }
        }
        
        function verifyPayment(id) {
            if(confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ ÙÛŒØ´ Ø±Ø§ ØªØ£ÛŒÛŒØ¯ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯ Ùˆ ÙˆØ¶Ø¹ÛŒØª Ø±Ø§ Ø¨Ù‡ "Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡" ØªØºÛŒÛŒØ± Ù…ÛŒâ€ŒØ¯Ù‡ÛŒØ¯ØŸ')) {
                const index = members.findIndex(m => m.id === id);
                if (index !== -1) {
                    members[index].status = 'paid';
                    members[index].nudgeCount = 0;
                    save();
                    
                    if (members[index].id === currentUserId) {
                        currentUser = members[index];
                    }

                    render(); 
                    renderAdminDashboard(); 
                    showToast(`ğŸ’° Ù¾Ø±Ø¯Ø§Ø®Øª ${members[index].name} ØªØ£ÛŒÛŒØ¯ Ø´Ø¯.`);
                }
            }
        }

        function deleteMember(id, name) {
            if(confirm(`Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ${name} Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ`)) {
                members = members.filter(m => m.id !== id);
                
                if (id === currentUserId) {
                    localStorage.removeItem(USER_ID_KEY);
                    currentUserId = null;
                    currentUser = null;
                }

                if (currentWinnerData && name === currentWinnerData.name) {
                    localStorage.removeItem(WINNER_KEY);
                    currentWinnerData = null;
                }
                
                monthlyArchives = monthlyArchives.map(archive => {
                    archive.members = archive.members.filter(m => m.id !== id);
                    return archive;
                });

                save();
                render(); 
                renderAdminDashboard(); 
                showToast(`ğŸ—‘ï¸ ${name} Ø­Ø°Ù Ø´Ø¯.`);
            }
        }
        
        // ğŸš¨ ØªØ§Ø¨Ø¹: Ø±ÛŒØ³Øª Ú©Ø§Ù…Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§ ØªØ£ÛŒÛŒØ¯ Ø¯Ùˆ Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ ğŸš¨
        function resetAllData() {
            if (!confirm("âš ï¸ Ø§Ø®Ø·Ø§Ø± Ø¬Ø¯ÛŒ! Ø¢ÛŒØ§ ÙˆØ§Ù‚Ø¹Ø§Ù‹ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§ØªØŒ Ø§Ø¹Ø¶Ø§ Ùˆ Ø¢Ø±Ø´ÛŒÙˆÙ‡Ø§ Ø±Ø§ Ù¾Ø§Ú© Ú©Ù†ÛŒØ¯ØŸ Ø§ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§Øª ØºÛŒØ± Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø³Øª.")) {
                showToast("Ø¹Ù…Ù„ÛŒØ§Øª Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ù„ØºÙˆ Ø´Ø¯.");
                return;
            }

            const confirmationCode = prompt("Ø¨Ø±Ø§ÛŒ ØªØ£ÛŒÛŒØ¯ Ù†Ù‡Ø§ÛŒÛŒØŒ Ù„Ø·ÙØ§Ù‹ Ø¹Ø¨Ø§Ø±Øª RESET-ALL Ø±Ø§ Ø¯Ø± Ú©Ø§Ø¯Ø± Ø²ÛŒØ± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:");

            if (confirmationCode === 'RESET-ALL') {
                localStorage.clear(); // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… localStorage
                
                // ØªÙ†Ø¸ÛŒÙ… Ù…Ø¬Ø¯Ø¯ Ø±Ù…Ø²Ù‡Ø§ÛŒ Ø¹Ø¨ÙˆØ± Ø¨Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶
                localStorage.setItem(ADMIN_PASS_KEY, DEFAULT_ADMIN_PASSWORD);
                localStorage.setItem(USER_PASS_KEY, DEFAULT_USER_PASSWORD);
                
                showToast("ğŸ—‘ï¸ ØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø´Ø¯. ØµÙØ­Ù‡ Ø±ÛŒØ³Øª Ù…ÛŒâ€ŒØ´ÙˆØ¯...");
                
                setTimeout(() => {
                    window.location.reload();
                }, 1500);

            } else if (confirmationCode !== null) {
                showToast("âŒ Ú©Ø¯ ØªØ£ÛŒÛŒØ¯ Ù†Ø§Ø¯Ø±Ø³Øª Ø¨ÙˆØ¯. Ø¹Ù…Ù„ÛŒØ§Øª Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ù„ØºÙˆ Ø´Ø¯.");
            } else {
                 showToast("Ø¹Ù…Ù„ÛŒØ§Øª Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ù„ØºÙˆ Ø´Ø¯.");
            }
        }


        function showAllReceipts(id, isArchive = false, monthCode = null) {
            let memberData;

            if (isArchive && monthCode) {
                 const archive = monthlyArchives.find(a => a.monthCode === monthCode);
                 memberData = archive ? archive.members.find(m => m.id === id) : null;
            } else {
                 memberData = members.find(m => m.id === id);
            }
            
            const contentDiv = document.getElementById('receiptsHistoryContent');
            const title = document.getElementById('adminReceiptsModalTitle');

            if (!memberData || !memberData.receipts || memberData.receipts.length === 0) {
                showToast('ÙÛŒØ´ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯.');
                return;
            }
            
            title.innerText = `ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø±Ø³ÛŒØ¯Ù‡Ø§ÛŒ ${memberData.name}`;
            contentDiv.innerHTML = '';
            
            memberData.receipts.slice().reverse().forEach((receipt, index) => {
                const date = receipt.timestamp ? toPersianDate(receipt.timestamp) : 'Ù†Ø§Ù…Ø´Ø®Øµ'; 
                
                const historyItem = document.createElement('div');
                historyItem.className = 'receipt-history-item';
                
                historyItem.innerHTML = `
                    <small>ØªØ§Ø±ÛŒØ® Ø§Ø±Ø³Ø§Ù„: ${date}</small>
                    <img src="${receipt.data}" alt="Ø±Ø³ÛŒØ¯ ÙˆØ§Ø±ÛŒØ²ÛŒ Ø´Ù…Ø§Ø±Ù‡ ${memberData.receipts.length - index}">
                `;
                contentDiv.appendChild(historyItem);
            });
            
            closeModal('summaryModal'); 
            openModal('adminReceiptsModal');
        }
        
        function viewReceiptForUser(id) { 
            const m = members.find(x => x.id === id);
            
            const latestReceipt = m && m.receipts && m.receipts.length > 0 ? m.receipts.sort((a, b) => b.timestamp - a.timestamp)[0].data : null;

            if(latestReceipt) { 
                document.getElementById('receiptImg').src = latestReceipt;
                openModal('receiptModal');
            } else {
                 showToast('ÙÛŒØ´ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯.');
            }
        }


        // --- Helpers ---
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        
        function openUpload(id) { 
             if (id !== currentUserId) {
                 showToast('âŒ Ø´Ù…Ø§ ÙÙ‚Ø· Ù…Ø¬Ø§Ø² Ø¨Ù‡ Ø¢Ù¾Ù„ÙˆØ¯ ÙÛŒØ´ Ø¨Ø±Ø§ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø®ÙˆØ¯ Ù‡Ø³ØªÛŒØ¯.');
                 return;
            }
            document.getElementById('uploadUserId').value = id; 
            document.getElementById('uploadFile').value = '';
            openModal('uploadModal'); 
        }

        function toggleSidebar() { 
            document.querySelector('.sidebar').classList.toggle('active'); 
            document.querySelector('.sidebar-overlay').classList.toggle('active'); 
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }
        
        function copyShareText(text) {
             navigator.clipboard.writeText(text).then(() => {
                showToast('Ù…ØªÙ† Ø®Ù„Ø§ØµÙ‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ú©Ù¾ÛŒ Ø´Ø¯! Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø§Ø´ØªØ±Ø§Ú©.');
             }).catch(err => {
                console.error('Failed to copy text: ', err);
                showToast('âŒ Ø®Ø·Ø§ÛŒÛŒ Ø¯Ø± Ú©Ù¾ÛŒ Ù…ØªÙ† Ø±Ø® Ø¯Ø§Ø¯.');
             });
        }


        // Start (ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ø§ÙˆÙ„ÛŒÙ‡)
        startCountdownTimer(); 
        
        // ğŸ”‘ Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª ÙˆØ±ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø±
        if (localStorage.getItem('userLoggedIn') !== 'true') {
             document.getElementById('userLoginModal').style.display = 'flex';
        } else {
             document.getElementById('userLoginModal').style.display = 'none'; 
             document.getElementById('mainAppContainer').style.display = 'block';
             document.getElementById('countdownContainer').style.display = 'block';
             document.getElementById('mainNavBar').style.display = 'flex';
             render();
        }


    </script>
</body>
</html>